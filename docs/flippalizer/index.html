<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="icon" href="/favicon.png"></link>
        <link rel="stylesheet" type="text/css" href="../style/style.css"></link>
        <title>Grapple's Pippling Flippalizer</title>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script src="js/lib.js"></script>
    <style>
        .pipset {
            border: 1px solid;
        }
    </style>
</head>

    <!--
        TODO: UI. Have a pip color chooser that lets you choose from the 5 colors. Have a data field for the number 
                  with an up/down. Allow you to add new rows for new pips, and there are three columns. 
                  Pip color chooser also needs a 'no pip' option.
        TODO: UI. Be able to save a result so you can compare later. 
        TODO: UI. Want to do charting. This coulde include showing the charting of all values calculated, with the 
                  ones where the operator was true in a different colour. Also could be a chart for the saved tests.
                  This will involve various rejigging in the engine of the code.
        TODO: Some kind of best fit notion. Have it run over the flips looking for the best return value.
              This involves indicating something is variable. 
              One approach is to indicate the deck as WG*BK*, and it will adjust those numbers, keeping a max of 40.
              It could know the counts for how many of each pip type there are. Or maybe just the ones that have less 
              than 14 cards. 
        TODO: Load pips from FM. Maybe file upload (into browser?) an OCTGN file, and it has its own json file 
              with the pips on each card.
        TODO: Automatic tables for pip-patterns. ie:   W3:12O37:28 would calculate multiple times over to form a table.
              Or should it be more specific, i.e.:    range(W,3,12) range(O,37,28). A fourth parameter could be the step.
              Ranges would lead to tables being output, which would include the pattern as a first column and the number 
              of cards as a second. 
        TODO: Make white=+2 a default-on option. 
        TODO: Show a running total in the Chosen Deck section.
    -->


    <script>
        function test_from_form() {
            let flip_count = parseInt($("#flip").val() );
            let iteration_count = parseInt( $("#iterations").val() );
            let queries = $("#pipql").val().split(',');

            let pip_pattern = "";
            for (child of $("#chosen_deck").children('li')) {
                pip_pattern += $(child).find("[type='hidden']").val();
            }

            if(pip_pattern == "") {
                pip_pattern = $("#pip_pattern").val();
            }

            pip_set = pattern_to_pip_set(pip_pattern);

            console.log("Running: run_test(" + pip_pattern + ", " + queries + ", " + iteration_count + ", " + flip_count + ")");
            all_results = run_test( pip_set, queries, iteration_count, flip_count );

            let text = "<tr><th>Pip Pattern</th>";
            for (query of queries) {
                text += "<th>" + query + "</th>";
            }
            text += "</tr>";
            $("#pip_results").html(text);
            for(let results of all_results) {
                text = "<tr><td>" + pip_set_to_pattern(results['pipset']) + "</td>";
                for (let i = 0; i < results['result'].length; i++) {
                    text += "<td>" + format_result(results['result'][i], queries[i]) + "</td>";
                }
                text += "</tr>";

                $("#pip_results").append(text);
            }
            return false;
        }
    </script>
    </head>
    <body>
<h1 id='sitetitle'><a href="../index.html">Freelance Peace Keeping</a></h1>
<div class="content" style="width: 90%;">

<p class="commentary">"I don't always plan my attacks, but when I do, I always use Grapple's Frappling Pippalizer.... erm, Pappling Flappalizer.... gah, This Page!! (Remind me again how much these endorsements pay?)"</p>

<div class="article" style="background-image: url('img/GrappleTruck.jpg'), url('img/GrappleBot.jpg'); background-repeat: no-repeat; background-position: left -10px, right -10px;">
<h1 style="text-align: center;">Grapple's Pippling Flippalizer</h1>
<br/><br/>

<div style="width: 98%">

            <ul class="nobullet tightlist">
                    <li>
                    <fieldset style="background-color: white">
              <legend style="background-color: white; border-radius: 6px;">Deck</legend>
              <ul class="nobullet">
                  <li>
              <fieldset>
                  <legend>Battle Icons:</legend>
                  <select id="battleicons1">
                      <option value="X"></option>
                      <option value="K">Black</option>
                      <option value="B">Blue</option>
                      <option value="G">Green</option>
                      <option value="O">Orange</option>
                      <option value="W">White</option>
                  </select>
                  <select id="battleicons2">
                      <option value="X"></option>
                      <option value="K">Black</option>
                      <option value="B">Blue</option>
                      <option value="G">Green</option>
                      <option value="O">Orange</option>
                      <option value="W">White</option>
                  </select>
                  <select id="battleicons3">
                      <option value="X"></option>
                      <option value="K">Black</option>
                      <option value="B">Blue</option>
                      <option value="G">Green</option>
                      <option value="O">Orange</option>
                      <option value="W">White</option>
                  </select>
              </fieldset>
                  </li>
                  <li>
              <fieldset>
                  <legend>Static</legend>
                  <label for="card_count">Count:</label>
                  <input id="card_count"/>
                  <input type="button" value="Add" onClick="add_pipset()"/>
              </fieldset>
                  </li>
                  <li>
              <fieldset>
                  <legend>Varying</legend>
                  <label for="varying_start">Start:</label>
                  <input id="varying_start" size="2"/>
                  <label for="varying_end">End:</label>
                  <input id="varying_end" size="2"/>
                  <label for="varying_step">Step:</label>
                  <input id="varying_step" value="1" size="2"/>
                  <br/>
                  <input type="button" value="Add Range" onClick="add_ranged_pipset()"/>
              </fieldset>
                  </li>
                  <li>
              <fieldset>
                  <legend>Pip Pattern</legend>
                  <label>Text:</label>
                  <input id="pip_pattern"/>
              </fieldset>
                  </li>
              </ul>
          </fieldset>
          </li>

          <li>
              <fieldset style="background-color: white">
        <legend>Chosen Deck</legend>
        <ul class="nobullet tightlist" id="chosen_deck">
        </ul>
    </fieldset>
          </li>
          <li>
          <fieldset style="background-color: white">
              <legend>Query</legend>
              <label for="iterations">Iterations:</label>
              <input id="iterations" value="10000" size="6"/>
              <label for="flip">Flip:</label>
              <input id="flip" value="2" size="2"/>
              <br/>
              <label for="pipql" style="display: block;">PIPQL Query:</label>
              <textarea id="pipql" rows="6" cols="80" style="display: block;"></textarea>
              <button type="button" onClick="test_from_form()">Run Query</button>
          </fieldset>
          </li>

    <script>
        function remove_pipset(element) {
            $(element).parent().remove();
        }
        function icon_letter_to_img_html(letter) {
            switch(letter) {
                case "O" :
                    return '<img src="img/piporange.png"/>';
                case "B" :
                    return '<img src="img/pipblue.png"/>';
                case "K" :
                    return '<img src="img/pipblack.png"/>';
                case "W" :
                    return '<img src="img/pipwhite.png"/>';
                case "G" :
                    return '<img src="img/pipgreen.png"/>';
                default:
                    return '';
            }
        }
        function get_icons() {
            // get the three pip colors
            let battleicons_1=$("#battleicons1").val();
            let battleicons_2=$("#battleicons2").val();
            let battleicons_3=$("#battleicons3").val();

            // if all three are X, then use the blank pip. Otherwise ignore X
            let img_text = "";
            let pip_text = "";
            if(battleicons_1 == "X" && battleicons_2 == "X" && battleicons_3 == "X") {
                pip_text = "X";
                img_text = '<img src="img/pipblank.png"/>';
            } else {
                if(battleicons_1 != "X") {
                    pip_text += battleicons_1;
                    img_text += icon_letter_to_img_html(battleicons_1);
                }
                if(battleicons_2 != "X") {
                    pip_text += battleicons_2;
                    img_text += icon_letter_to_img_html(battleicons_2);
                }
                if(battleicons_3 != "X") {
                    pip_text += battleicons_3;
                    img_text += icon_letter_to_img_html(battleicons_3);
                }
            }
            return [pip_text, img_text];
        }
        function add_pipset() {
            let card_count=$("#card_count").val();
            append_pipset_html(card_count, card_count);
        }
        function append_pipset_html(count_code, count_text) {
            icon_data = get_icons();

            // Build HTML
            let text = '<li class="pipset"><input type="hidden" value="' + icon_data[0] + count_code +'"/><img class="close" src="img/x-square.svg" onclick="remove_pipset(this)">' + icon_data[1] + ' &times; ' + count_text + '</li>';
            // Append HTML
            $("#chosen_deck").append(text);
        }
        function add_ranged_pipset() {
            let varying_start=$("#varying_start").val();
            let varying_end=$("#varying_end").val();
            let varying_step=$("#varying_step").val();

            let count_code = varying_start + ':' + varying_end;
            if(varying_step != "" && varying_step != "1") {
                count_code += ':' + varying_step;
            }
            
            let count_text = varying_start + " &rarr;";
            if(varying_step != "" && varying_step != "1") {
                count_text += '<sup style="font-size: 0.5em;">' + varying_step + '</sup>';
            }
            count_text += ' ' + varying_end;

            append_pipset_html(count_code, count_text);
        }
    </script>

<style>
.pipset {
   /*float: left; */
   padding: 2px;
   margin: 2px;
   font-size: 3em;
}
.pipset .close {
    float: right;
    cursor: pointer;
}
.tightlist {
    display: inline-block;
}
.nobullet li {
    list-style-type: none;
}

#pip_results {
  border-collapse: collapse;
  width: 100%;
}

#pip_results td, #pip_results th {
  border: 1px solid #ddd;
  padding: 8px;
}

#pip_results tr:nth-child(even){background-color: #f2f2f2;}

#pip_results tr:hover {background-color: #ddd;}

#pip_results th {
  padding-top: 12px;
  padding-bottom: 12px;
  text-align: left;
  background-color: #ffef00;
  color: blue;
}

</style>

<li>
<br/> <br/> 
    <fieldset>
        <legend>Results</legend>
        <table id="pip_results"></table>
    </fieldset>
</li>
</ul>

    <br/><br/>

    <hr/>

    <div class="sidebar-right">
    <h3>PIPQL Help</h3>
    <p>There are currently two functions available in PIPQL: </p>
    <ol>
        <li>count. This counts the number of times a pip shows. Its parameter is unique, so count(O) is the same as count(OO); that is the second O is meaningless. Using count(*) is a shorthand to count all pips that show.  </li>
        <li>colours/colors. This counts the number of times a colour shows. Again the parameter is unique, so colours(OO) matches colours(O). colours(*) counts all the colours, colours(OB) would count how often an O or B shows. colours(OB) will never be greater than 2; as an example. </li>
    </ol>

    <p>Compound queries can be entered above in two ways. They can be joined together with ' AND ' to form the same query (see Ultra Magnus example below), or they can be run in parallel by separating with a comma. </p>
    <p>If a query has an operator, it will let you know the %age of times that that operation is true. i.e. '=4' will tell you how often the answer was 4. </p>
    <p>If a query does not have an operator, it will return the average (mean) of the values calculated. </p>
    <p>Whitespace is allowed in queries to improve readability. </p>

    <h3>Deck Format</h3>
    <p>Decks are described (until a nicer UI is made) as pieces of text consisting of the pips on a card type, followed by the number of those cards. O=Orange, B=Blue, K=Black, W=White, G=Green. Whitespace is allowed to improve readability. </p>

    <p>Decks can include ranges, leading to a tabular response. These are written with a start, end, and step, so that "G12:0:3" will test the deck with 12, 9, 6, 3, and 0 one Green battle iconed cards in the deck. It's up to you to ensure you are balancing this with another range that goes the other way to replace the removed cards with one Green battle icon. </p>

    <p>Note that you can use whatever single character notation you wish for battle icon colors, barring W. You'll only get the two extra flip effect if you use a W to represent White. Should you need to represent a blank pip card, feel free, prior to a dedicated UI, to invent your own notation. </p>

    <h3>PIPQL Examples</h3>
    <ul>
        <li>Grapple flipping two pips &rarr;  colours(*)=4</li>
        <li>Chromia flipping at least WW &rarr; count(W)&gt;1</li>
        <li>Ultra Magnus flipping OOBB &rarr; count(O)&gt;=2 AND count(B)&gt;=2</li>
        <li>Fortress Maximus flipping OK &rarr; colours(OK)=2</li>
        <li>Private Red Alert flipping WOB &rarr; colours(WOB)=3</li>
        <li>Slipstream flipping &gt;2 colours &rarr; colours(*)&gt;2</li>
        <li>Average number of orange/black in a flip &rarr; count(O),count(K)</li>
    </ul>

    <h3>Deck Examples</h3>
    <ul>
        <li>O20B20 &rarr; A deck with 20 cards with one Orange battle icon, and 20 cards with one Blue battle icon</li>
        <li>O20OB20 &rarr; A deck with 20 cards with one Orange battle icon, and 20 cards with one Blue battle icon AND one Orange icon</li>
        <li>WG3:36:3 OK37:4:3 &rarr; This tests a range of decks, starting with one with 3 WhiteGreen cards and 37 OrangeBlack cards, moving in increments of 3 to a deck with 36 WhiteGreen cards and 4 OrangeBlack cards. </li>
    </ul>

    <h3>Provisos</h3>
    <p>Enter weird input, you'll get weird behaviour. Enter a huge number of iterations, your browser will lock up. 100000 is probably as high as you want/need to go. </p>
    </div>

    </div>

<p class="footer">Comic Book images courtesy of tfwiki.net under <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA-3.0</a>. </p>
    </body>
    </html>
